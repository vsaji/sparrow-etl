<?xml version="1.0" encoding="UTF-8"?>
<!--Sample XML file generated by XML Spy v4.4 U (http://www.xmlspy.com)-->
<SPEAR-CONFIG xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="spear.xsd">
	<MODULE>
		<NAME>Off-Prop link table populator</NAME>
		<PROCESS-ID>TEST</PROCESS-ID>
		<DESCRIPTION>For Testing</DESCRIPTION>
		<CYCLE-DEPENDENCIES>
			<ASSERTER CLASS="com.cs.sg.spear.core.cycledependency.SystemGCForcer"/>
			<ASSERTER CLASS="com.cs.sg.spear.core.cycledependency.StatsCollector"/>
		</CYCLE-DEPENDENCIES>
		<MODULE-PARAM>
		   <PARAM NAME="spear.semaphore.check" VALUE="false"/>
		   <PARAM NAME="spear.cycle.interval" VALUE="5000"/>
		   <PARAM NAME="spear.shutdown" VALUE="Wed:21:58"/>
		   <PARAM NAME="spear.cycle.count" VALUE="1"/>
		   <PARAM NAME="spear.cache.pool.size" VALUE="10"/>
    	   <PARAM NAME="spear.watcher.enable" VALUE="false"/>
   		   <PARAM NAME="spear.watcher.interval" VALUE="2000"/>	
		   <PARAM NAME="ftb.table" VALUE="tempdb..ftbq190309"/>	
		</MODULE-PARAM>
	</MODULE>
	<DATA-EXTRACTOR NAME="driver" TYPE="DB">
			<PARAM NAME="query1"><![CDATA[
				Select CollectionId, GroupId,  convert( char(8), ExecuteTime, 112 ) as executetime, BatchId, CounterPartyEntity from ${module@ftb.table} 
				where  ProductType in ('Stock')
				and BookingEntity not in ('CSFBI')
				and CounterPartyEntity not in ('CSFBI')
				and AllocationType in ('BOOK','EXCH')
				and BookingEntity in ('CSHKHK','CSFBHK')
				and (CounterPartyEntity ='EXCH' or CounterPartyName like '800-%')
				and DeliveryType=0
				and  len(ltrim(BatchId)) > 0 
			group by CollectionId, GroupId, convert( char(8), ExecuteTime, 112 ), BatchId, CounterPartyEntity
				]]></PARAM>


			<PARAM NAME="query2"><![CDATA[
				select CollectionId, GroupId,  convert( char(8), ExecuteTime, 112 ) as executetime, BatchId, CounterPartyEntity
				from   ${module@ftb.table} 
				where 
				ProductType in ('Stock')
				and    AllocationType in ('BOOK','EXCH')
				and    BookingEntity in ('CSHKHK','CSFBHK')
				and    BookingAccount = 'TRE'
				and   (CounterPartyEntity ='EXCH' or CounterPartyName like '800-%')
				and    DeliveryType=0
			    and     TransactionTime >= '20090309' 
			    and     TransactionTime < '20090310' 
				and SentToBOState='SENT'
				and  len(ltrim(BatchId)) > 0 
				group by CollectionId, GroupId, convert( char(8), ExecuteTime, 112 ), BatchId, CounterPartyEntity

			]]></PARAM>

			<PARAM NAME="query"><![CDATA[
				select (CollectionId-10000000) as ColId, CollectionId, GroupId,  convert( char(8), ExecuteTime, 112 ) as executetime, BatchId, CounterPartyEntity
				from   ${module@ftb.table} 
				where 
				ProductType in ('Stock')
				and    AllocationType in ('BOOK','EXCH')
				and    BookingEntity in ('CSHKHK','CSFBHK')
				and   (CounterPartyEntity ='EXCH' or CounterPartyName like '800-%')
				and    DeliveryType=0
		        and    char_length(convert(varchar,BookingAccount)) <= 4        
			    and     TransactionTime >= '20090304' 
			    and     TransactionTime < '20090305' 
				and  len(ltrim(BatchId)) > 0 
				group by CollectionId, GroupId, convert( char(8), ExecuteTime, 112 ), BatchId, CounterPartyEntity
			]]></PARAM>
			<PARAM NAME="resource" VALUE="FTBQDEV"/>
			<PARAM NAME="fetch.size" VALUE="0"/>
			<PARAM NAME="result.wrap" VALUE="disconnected"/>			
	</DATA-EXTRACTOR>
	<DATA-TRANSFORMER NAME="trans" TYPE="script" POOL-SIZE="10" THREAD-COUNT="5">
		<PARAM NAME="rejection.report.type" VALUE="file"/>
		<PARAM NAME="rejection.report.source" VALUE="C:/app/temp/pecs/report"/>
		<PARAM NAME="script.input" VALUE="inline"/>
		<PARAM NAME="script.lang" VALUE="java"/>
		<PARAM NAME="script.lang1" VALUE="mvel"/>
		<PARAM NAME="script.lang2" VALUE="js"/>
		<PARAM NAME="script.lang3" VALUE="velocity"/>
		<PARAM NAME="script.value"><![CDATA[

				import com.cs.sg.spear.core.vo.DBParamHolder;
				import com.cs.sg.spear.core.dao.impl.ResultRow;
				import java.util.ArrayList;
				import java.util.List;
			
				try{
				
				DBParamHolder dbph = new DBParamHolder();
				_dataout.addDBParamHolder("testLinkTable",dbph);
				ResultRow rr = _dataset.getDriverRow();

			    int count = _dataset.getLookupResult("exeCompLkp").getFirstRow().getInt(0).intValue();

				int noOfLeg = "CSFBJL".equals(rr.getValue("CounterPartyEntity")) ? 2 : 3;

				String collGrpId = rr.getValue("ColId") + rr.getValue("GroupId");
				collGrpId = collGrpId.trim();

				String batchId = rr.getValue("BatchId");
				batchId = batchId.substring(1).trim();

				String executeTime = rr.getValue("executetime");

			    List mainList = dbph.getParamList();
				
				for (int j=1; j< (noOfLeg+1); j++) {

					List prouatFOs = new ArrayList();

					prouatFOs.add("J:" + executeTime + ":" + batchId + ":" + j + ":0");
					prouatFOs.add("J:" + executeTime + ":" + collGrpId + ":" + j + ":0");
					mainList.add(prouatFOs);

					for (int i=1; i < (count+1); i++) {
					  List prouatFOs1 = new ArrayList();
					  prouatFOs1.add("J:" + executeTime + ":" + batchId + ":" + j + ":" + i);
					  prouatFOs1.add("J:" + executeTime + ":" + collGrpId + ":" + j + ":" + i);
					  mainList.add(prouatFOs1);
					}
				 }
				
				}catch(Exception ex){
					throw ex;
				}

		]]></PARAM>

		<PARAM NAME="script.value3"><![CDATA[

		#set( $dbph = $util.createObject("com.cs.sg.spear.core.vo.DBParamHolder"))
		$dataout.addDBParamHolder("testLinkTable",$dbph)
		#set( $rr = $dataset.getDriverRow())
		#set( $count = $dataset.getLookupResult("exeCompLkp").getFirstRow().getInt(0).intValue())
		#if($rr.getValue("CounterPartyEntity")=="CSFBJL" )
			#set( $noOfLeg = 2)
		#else 
			#set( $noOfLeg = 3)
		#end
		#set($GroupId = $rr.getValue("GroupId").trim())
		#set( $collGrpId = $rr.getValue("CollectionId").trim())
		#set( $colGrpId = "$collGrpId$GroupId")
		#set( $batchId = $rr.getValue("BatchId").substring(1).trim())
		#set( $executeTime = $rr.getValue("executetime"))
	    #set( $mainList = $dbph.getParamList())

			#foreach($j in [1..$noOfLeg])
				
				#set( $prouatFOs = $util.createObject("java.util.ArrayList"))
			
				$prouatFOs.add("J:$executeTime:$batchId:$j:0")
				$prouatFOs.add("J:$executeTime:$colGrpId:$j:0")
				$mainList.add($prouatFOs)

				#foreach($i in [1..$count]) 
				
				  #set( $prouatFOs = $util.createObject("java.util.ArrayList"))
				  
				  $prouatFOs.add("J:$executeTime:$batchId:$j:$i")
				  $prouatFOs.add("J:$executeTime:$colGrpId:$j:$i")
				  $mainList.add($prouatFOs)

				#end
			 #end
		
		]></PARAM>	
		<PARAM NAME="script.value2"><![CDATA[

				dbph = new Packages.com.cs.sg.spear.core.vo.DBParamHolder();
				dataout.addDBParamHolder("testLinkTable",dbph);

				rr = dataset.getDriverRow();


				count = dataset.getLookupResult("exeCompLkp").getFirstRow().getInt(0).intValue();

				noOfLeg = "CSFBJL".equals(rr.getValue("CounterPartyEntity")) ? 2 : 3;

				collGrpId = rr.getValue("CollectionId") + rr.getValue("GroupId");
				colGrp = collGrpId;
				
				logger.info("Result Row:"+rr);


				batchId = rr.getValue("BatchId");
				batchId = batchId.substring(1);

				executeTime = rr.getValue("executetime");

			    mainList = dbph.getParamList();

				for(j=1;j<noOfLeg;j++) {

				prouatFOs = new java.util.ArrayList();
				prouatFOs.add("J:" + executeTime + ":" + batchId + ":" + j + ":0");
				prouatFOs.add("J:" + executeTime + ":" + collGrpId + ":" + j + ":0");
				mainList.add(prouatFOs);

				for(i=1;i<count;i++) {

				  prouatFOs = new  java.util.ArrayList();
				  prouatFOs.add("J:" + executeTime + ":" + batchId + ":" + j + ":" + i);
				  prouatFOs.add("J:" + executeTime + ":" + collGrpId + ":" + j + ":" + i);
				  mainList.add(prouatFOs);
				}
			  }


				//java.lang.System.out.println("mainList : "+mainList);
	
		]]></PARAM>	
		<PARAM NAME="script.value1">
			<![CDATA[ 
				import com.cs.sg.spear.core.vo.DBParamHolder;
				import java.util.ArrayList;
		
				dbph = new DBParamHolder();
				dataout.addDBParamHolder("testLinkTable",dbph);

				rr = dataset.getDriverRow();

			    count = dataset.getLookupResult("exeCompLkp").getFirstRow().getInt(0).intValue();

				noOfLeg = "CSFBJL".equals(rr.getValue("CounterPartyEntity")) ? 2 : 3;

				collGrpId = rr.getValue("CollectionId") + rr.getValue("GroupId");
				collGrpId = collGrpId.trim();

				batchId = rr.getValue("BatchId");
				batchId = batchId.substring(1).trim();

				executeTime = rr.getValue("executetime");

			    mainList = dbph.getParamList();
				
				j=1;
				foreach (j : noOfLeg) {

				prouatFOs = new ArrayList();
				prouatFOs.add("J:" + executeTime + ":" + batchId + ":" + j + ":0");
				prouatFOs.add("J:" + executeTime + ":" + collGrpId + ":" + j + ":0");
				mainList.add(prouatFOs);
				i=1;
				foreach (i : (count)) {

				  prouatFOs = new ArrayList();
				  prouatFOs.add("J:" + executeTime + ":" + batchId + ":" + j + ":" + i);
				  prouatFOs.add("J:" + executeTime + ":" + collGrpId + ":" + j + ":" + i);
				  mainList.add(prouatFOs);
				}
			  }
			]]>
		</PARAM>
	</DATA-TRANSFORMER>

	<DATA-WRITERS ON-ERROR="failall" THREAD-COUNT="5">
		<WRITER NAME="linkTableWriter" TYPE="DB" >
			<PARAM NAME="query"><![CDATA[insert into MIGRATIONTESTLINK (FOID, PRODFOINTRLID,UATFOINTRLID,STAMP_ADD_DTIME) values (123, ?, ?, sysdate)]]></PARAM>
			<PARAM NAME="resource" VALUE="CSARUAT2"/>
			<PARAM NAME="key.name" VALUE="testLinkTable"/>
			<PARAM NAME="batch.size" VALUE="10"/>
			<PARAM NAME="batch.per.request" VALUE="true"/>
		</WRITER>
	</DATA-WRITERS>
	<RESOURCES>
		<RESOURCE NAME="CSARUAT" TYPE="DB" LOAD-PRIORITY="2" UNLOAD-PRIORITY="1">
			<PARAM NAME="driver.classname" VALUE="oracle.jdbc.OracleDriver"/>
			<PARAM NAME="connection.url" VALUE="jdbc:oracle:thin:@sgs75h-090d.sg.csfb.com:1521:QSGCSAR1"/>
			<PARAM NAME="user.name" VALUE="odsadm"/>
			<PARAM NAME="password" VALUE="changi2oo6"/>
			<PARAM NAME="pool.size" VALUE="10"/>
			<PARAM NAME="pool.on.start" VALUE="false"/>
			<PARAM NAME="max.wait" VALUE="5000"/>
			<PARAM NAME="default.autocommit" VALUE="true"/>
		</RESOURCE>
		<RESOURCE NAME="CSARUAT2" TYPE="DB" LOAD-PRIORITY="2" UNLOAD-PRIORITY="1">
			<PARAM NAME="driver.classname" VALUE="oracle.jdbc.OracleDriver"/>
			<PARAM NAME="connection.url" VALUE="jdbc:oracle:thin:@sgs69h-0001z.sg.csfb.com:1521:QSGCSAR2"/>
			<PARAM NAME="user.name" VALUE="odsadm"/>
			<PARAM NAME="password" VALUE="changi2oo6"/>
			<PARAM NAME="pool.size" VALUE="10"/>
			<PARAM NAME="pool.on.start" VALUE="false"/>
			<PARAM NAME="max.wait" VALUE="5000"/>
			<PARAM NAME="default.autocommit" VALUE="true"/>
		</RESOURCE>
		<RESOURCE NAME="CSARDEV" TYPE="DB" LOAD-PRIORITY="2" UNLOAD-PRIORITY="1">
			<PARAM NAME="driver.classname" VALUE="oracle.jdbc.OracleDriver"/>
			<PARAM NAME="connection.url" VALUE="jdbc:oracle:thin:@sgs75h-090d.sg.csfb.com:1521:DSGCSAR2"/>
			<PARAM NAME="user.name" VALUE="odsadm"/>
			<PARAM NAME="password" VALUE="odsadm"/>
			<PARAM NAME="pool.size" VALUE="10"/>
			<PARAM NAME="pool.on.start" VALUE="false"/>
			<PARAM NAME="max.wait" VALUE="5000"/>
			<PARAM NAME="default.autocommit" VALUE="true"/>
		</RESOURCE>
	    <RESOURCE NAME="FTBQPROD" TYPE="DB" LOAD-PRIORITY="3" UNLOAD-PRIORITY="1">
			<PARAM NAME="driver.classname" VALUE="net.sourceforge.jtds.jdbc.Driver"/>
			<PARAM NAME="connection.url" VALUE="jdbc:jtds:sybase://158.216.134.66:2300/pftb_brt01"/>
			<PARAM NAME="user.name" VALUE="ptk_ftbt_ro1"/>
			<PARAM NAME="password" VALUE="ptk_ftbt_ro1_prod"/>
			<PARAM NAME="pool.size" VALUE="10"/>
			<PARAM NAME="pool.on.start" VALUE="false"/>
			<PARAM NAME="max.wait" VALUE="5000"/>
			<PARAM NAME="default.autocommit" VALUE="true"/>
	  </RESOURCE>
	  <RESOURCE NAME="FTBQDEV" TYPE="DB" LOAD-PRIORITY="3" UNLOAD-PRIORITY="1">
			<PARAM NAME="driver.classname" VALUE="com.sybase.jdbc3.jdbc.SybDriver"/>
			<PARAM NAME="connection.url" VALUE="jdbc:sybase:Tds:158.216.23.71:2301/BATSGD06"/>
			<PARAM NAME="user.name" VALUE="batsgd_dbo"/>
			<PARAM NAME="password" VALUE="batsgd_dbo"/>
			<PARAM NAME="pool.size" VALUE="30"/>
			<PARAM NAME="pool.on.start" VALUE="false"/>
			<PARAM NAME="max.wait" VALUE="5000"/>
			<PARAM NAME="default.autocommit" VALUE="true"/>
	  </RESOURCE>
	</RESOURCES>
	<DATA-PROVIDERS>
		<DATA-PROVIDER NAME="executionCompression1" TYPE="PROC">
			<PARAM NAME="query"><![CDATA[ 
				RecordSet rs = null;
				try{
				   // System.out.println("Thread Name:"+Thread.currentThread().getName());
					//System.out.println("Time:"+System.currentTimeMillis()+"=Thread Name:"+Thread.currentThread().getName()+"=Collection ID : "+_dataset.get("driver$CollectionId") + ", Group Id : "+_dataset.get("driver$GroupId") );

					if(1==1){
						_datahandler.beginTrans();
						rs = _datahandler.getData("executionCompression1");
						_dataset.put("foid",new Integer(57193));
						//RecordSet rs1 = _datahandler.getData("mtl_select");
						_datahandler.executeQuery("mtl_insert");
						_datahandler.rollbackTrans();
					}
				}catch(DataException ex){
					throw ex;
				}

				return rs;
			 ]]></PARAM>
		</DATA-PROVIDER>	

		<DATA-PROVIDER NAME="wrapper" TYPE="PROC">
			<PARAM NAME="query"><![CDATA[
				RecordSetImpl_Disconnected rsd=null;
				try{
					RecordSet rs = _datahandler.getData("executionCompression");
					rsd = new RecordSetImpl_Disconnected();
					rsd.addRow(new ResultRowImpl(rs.getColumnHeaders(),rs.getRow(0).getValues()));
				}catch(DataException ex){
					throw ex;
				}
				return rsd;
			 ]]></PARAM>
		</DATA-PROVIDER>

		<DATA-PROVIDER NAME="executionCompression" TYPE="DB">
			<PARAM NAME="query"><![CDATA[ 
			select count(1) as execution_count from (select count(1) as ex_count from 
			${module@ftb.table}  where CollectionId =${driver$CollectionId}	and GroupId = ${driver$GroupId} group by 
			CollectionId, GroupId, TradePrice) a
			 ]]></PARAM>
			<PARAM NAME="resource" VALUE="FTBQDEV"/>
			<PARAM NAME="fetch.size" VALUE="0"/>
			<PARAM NAME="result.wrap" VALUE="disconnected"/>
		</DATA-PROVIDER>	

		<DATA-PROVIDER NAME="mtl_select" TYPE="DB">
			<PARAM NAME="query"><![CDATA[select * from MIGRATIONTESTLINK1 where FOID=${foid}]]></PARAM>
			<PARAM NAME="resource" VALUE="CSARDEV"/>
			<PARAM NAME="fetch.size" VALUE="0"/>
			<PARAM NAME="result.wrap" VALUE="disconnected"/>
		</DATA-PROVIDER>	

		<DATA-PROVIDER NAME="mtl_insert" TYPE="DB">
			<PARAM NAME="query"><![CDATA[insert into MIGRATIONTESTLINK1 (FOID, PRODFOINTRLID,UATFOINTRLID,STAMP_ADD_DTIME) values(12311,'TEST','TEST11',SYSDATE)]]></PARAM>
			<PARAM NAME="resource" VALUE="CSARDEV"/>
			<PARAM NAME="fetch.size" VALUE="0"/>
			<PARAM NAME="result.wrap" VALUE="disconnected"/>
		</DATA-PROVIDER>	

	</DATA-PROVIDERS>
	
	<DATA-LOOKUP>				
		<LOOKUP NAME="exeCompLkp" DATA-PROVIDER="executionCompression"></LOOKUP>
	</DATA-LOOKUP>
	
	<EXCEPTION-HANDLER>
		<HANDLER CLASS="com.cs.sg.spear.core.exception.SpearExceptionHandler" NAME="default.exception.handler"/>
		
		<HANDLE EXCEPTION="com.cs.sg.spear.core.exception.ValidatorException" HANDLER="default.exception.handler">
			<ERROR CODE="ERROR_THRESHOLD_EXCEEDED"  VALUE="*" TYPE="fatal"/>
		</HANDLE>

		<HANDLE EXCEPTION="java.sql.SQL1Exception" HANDLER="default.exception.handler">
			<ERROR CODE="SQL_EXCEPTION"  VALUE="*" TYPE="fatal"/>
		</HANDLE>
		
		<HANDLE EXCEPTION="com.cs.sg.spear.core.exception.SpearRuntimeException" HANDLER="default.exception.handler">
			<ERROR CODE="LOOKUP_NOT_FOUND"  VALUE="*" TYPE="fatal"/>
		</HANDLE>		
	</EXCEPTION-HANDLER>
	
</SPEAR-CONFIG>
