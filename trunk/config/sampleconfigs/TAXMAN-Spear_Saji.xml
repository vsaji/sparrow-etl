<?xml version="1.0" encoding="UTF-8"?>
<!--Sample XML file generated by XML Spy v4.4 U (http://www.xmlspy.com)-->
<SPEAR-CONFIG xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="spear.xsd">
	<MODULE>
		<NAME>Taxman File upload</NAME>
		<PROCESS-ID>Taxman</PROCESS-ID>
		<DESCRIPTION>Taxman File upload</DESCRIPTION>
		<CYCLE-DEPENDENCIES>
			<ASSERTER CLASS="com.cs.sg.spear.core.cycledependency.SystemGCForcer"/>
			<ASSERTER CLASS="com.cs.sg.spear.core.cycledependency.StatsCollector"/>
		</CYCLE-DEPENDENCIES>
		<MODULE-PARAM>
		   <PARAM NAME="spear.semaphore.check" VALUE="false"/>
		   <PARAM NAME="spear.keyassigner" VALUE="com.cs.sg.spear.impl.assigner.RoundRobinKeyAssigner"/>
                   <PARAM NAME="taxman.feed.delimit" VALUE="@@feed.delimit@@"/>
               	   <PARAM NAME="taxman.col.def" VALUE="@@col.def@@"/> 
               	   <PARAM NAME="taxman.file.name" VALUE="@@file.name@@"/> 
                   <PARAM NAME="taxman.base.dir" VALUE="@@base.dir@@"/>
                   <PARAM NAME="taxman.syb.server" VALUE="@@syb.server@@"/>
                   <PARAM NAME="taxman.syb.tempdb" VALUE="@@syb.tempdb@@"/> 
                   <PARAM NAME="taxman.syb.tempdbuname" VALUE="@@syb.tempdbuname@@"/>
                   <PARAM NAME="taxman.syb.tempdbpwd" VALUE="@@syb.tempdbpwd@@"/>
                   <PARAM NAME="spear.cycle.count" VALUE="5"/>
		</MODULE-PARAM>
	</MODULE>
	<DATA-EXTRACTOR NAME="driver" TYPE="CSV">
		<PARAM NAME="fetch.size" VALUE="500"/>
		<PARAM NAME="result.wrap" VALUE="disconnected"/>
		<PARAM NAME="file.path" VALUE="p:\"/>
		<PARAM NAME="file.name" VALUE="CAPS-testing.txt"/>
		<PARAM NAME="file.delimiter" VALUE="${module@taxman.feed.delimit}"/>
	        <PARAM NAME="column.definition" VALUE="${module@taxman.col.def}"/>
		<PARAM NAME="trim.value" VALUE="true"/>
		<PARAM NAME="start.line.number" VALUE="2"/>
		<PARAM NAME="validation.required" VALUE="false"/>
		<PARAM NAME="rejection.report.type" VALUE="file"/>
		<PARAM NAME="rejection.report.source" VALUE="${module@taxman.base.dir}/logs"/>
		<PARAM NAME="fail.dir" VALUE="${module@taxman.base.dir}/logs"/>
		<PARAM NAME="post.process" VALUE="ignore"/>
		<PARAM NAME="post.process.dir" VALUE="${module@taxman.base.dir}/logs"/>
		<PARAM NAME="wait.for.file" VALUE="true"/>
		<PARAM NAME="polling.interval" VALUE="5000"/>
		<PARAM NAME="polling.count" VALUE="10"/>
	</DATA-EXTRACTOR>
	<!--
	<DATA-TRANSFORMER NAME="fitTransform" CLASS="com.cs.sg.spear.impl.transformer.DummyDataTransformer" POOL-SIZE="1" THREAD-COUNT="1" >
		<PARAM NAME="template.type" VALUE="string"/>
		<PARAM NAME="placeholder" VALUE="object"/>
		<PARAM NAME="template.value" VALUE="Dummy"/>
		<PARAM NAME="ignore.null" VALUE="true"/>
		<PARAM NAME="replace.null.with" VALUE=""/>
		<PARAM NAME="rejection.report.type" VALUE="file"/>
		<PARAM NAME="rejection.report.source" VALUE="${module@taxman.base.dir}/logs"/>
	</DATA-TRANSFORMER>
	-->
	<DATA-TRANSFORMER NAME="fitTransform" TYPE="script" POOL-SIZE="150" THREAD-COUNT="1">
		<PARAM NAME="script.input" VALUE="inline"/>
		<PARAM NAME="script.lang" VALUE="mvel"/>
		<PARAM NAME="script.value"><![CDATA[
			import com.cs.sg.spear.core.exception.ValidatorException;
			import com.cs.sg.spear.core.vo.MessageHolder;
			import java.util.HashMap;
			
			dset_keyval  	= _dataset.getDataSetAsKeyValue();
			
			System.out.println("SEED_NUM  count= " + _dataset.getLookupResult("SEED_NUM").getRowCount());			
			
			TTBFX_rate	= dset_keyval.get("FX_RATE$TTBFXRate");
			FX_rate 	= dset_keyval.get("FX_RATE$FXRate");
			
			DTA_rate 	= dset_keyval.get("DTA_RATE$DTARate");
			ReliefAtSource  = dset_keyval.get("DTA_RATE$IsReliefAvailabeAtSource");
			
			TAX_rate 	= dset_keyval.get("TAX_RATE$TaxRate");
			LOCALTAX_rate   = dset_keyval.get("TAX_RATE$LocalTaxRate");

			System.out.println("TTBFX_rate = " + TTBFX_rate  );
			System.out.println("DTA_rate = " + DTA_rate  );
			System.out.println("TAX_rate = " + TAX_rate  );
			
			SEED_num	= dset_keyval.get("SEED_NUM$seq_num");
			System.out.println("SEED_num = " + SEED_num  );
			
			if(TTBFX_rate ==null || FX_rate ==null)
			{
				_this.markForRejection("FX rate is missing for ["+dset_keyval.get("driver$tradeccy")+"]");
				new ValidatorException("MISSING_FX_RATE","missing FX rate");
			}
			if(DTA_rate ==null)
			{
				_this.markForRejection("DTA rate is missing for ["+'JP'+"]");
				new ValidatorException("MISSING_DTA_RATE","missing DTA rate");
			}
			if(TAX_rate ==null || LOCALTAX_rate ==null)
			{
				_this.markForRejection("TAX rate is missing for ["+'302-500623'+"]");
				new ValidatorException("MISSING_TAX_RATE","missing TAX rate");
			}
			if(ReliefAtSource == 'Y')
			{
				Gross_Amt = dset_keyval.get("driver$quantity");
				System.out.println("Gross_Amt = " + Gross_Amt  );
				FGN_Tax	= (Gross_Amt * DTA_rate);
				Net_Amt	= (Gross_Amt - FGN_Tax);
				System.out.println("FGN_Tax = " + FGN_Tax  );
				System.out.println("Net_Amt = " + Net_Amt  );
			}
			else
			{
				FGN_Tax	= dset_keyval.get("driver$taxamount");
				Net_Amt	= dset_keyval.get("driver$netamount");
			}
			_dataset.getDataSetAsKeyValue().put("FGN_Tax",new Integer(FGN_Tax));
			_dataset.getDataSetAsKeyValue().put("Net_Amt",new Integer(Net_Amt));


			MessageHolder mh = new MessageHolder();
			mh.addMessage("Test Message1");
			mh.addMessage("Test Message2");

			_dataout.addMessageHolder("test",mh);
			//dataset.getDataSetAsKeyValue().put("Gross_Amt_TTBFX_2",new Integer(TAX_rate));

		]]>
		</PARAM>
		<PARAM NAME="rejection.report.type" VALUE="file"/>
		<PARAM NAME="rejection.report.source" VALUE="${module@taxman.base.dir}/logs"/>
	</DATA-TRANSFORMER>
	<DATA-WRITERS ON-ERROR="ignore" THREAD-COUNT="1">
		<WRITER NAME="dbwrite1" TYPE="DB" >
			<PARAM NAME="query"><![CDATA[
			BEGIN
				insert into tempdb..EntitlementPC 
				( EntitlementID,InputDate,AccountNum,EventType,SecCode,CurrCode,Position,GrossAmt,FGN_TaxAmt,NetAmt,ContraFlag,Ird,TxnType,CashSettDate,Account,Entity,Bookdate,DepoDate,LongShortInd,ActionID,PosType,PosSubType,ExDate,RecordDate,STPFlag,TTBFXRate,FXRate,DTARate,ReliefAtSource,NationalTaxRate,LocalTaxRate ) 
				values 
				( '1000000000',getDate(),${driver$counterparty},${driver$destinationsystemid},${driver$securityid},${driver$tradeccy},${driver$position},${driver$quantity},${FGN_Tax},${Net_Amt},${driver$contraflag},${driver$ird},${driver$txnType},
				  ${driver$cashsettdate},${driver$account},${driver$entity},${driver$bookdate},${driver$depodate},${driver$longshortind},${driver$actionid},${driver$postype},${driver$possubtype},${driver$exdate},${driver$recorddate},${driver$stpflag},${FX_RATE$TTBFXRate},${FX_RATE$FXRate},${DTA_RATE$DTARate},${DTA_RATE$IsReliefAvailabeAtSource},${TAX_RATE$TaxRate},${TAX_RATE$LocalTaxRate})                    
				
				insert into tempdb..EntitlementPC_JPY 
				( EntitlementID,InputDate,Net_Amt_FX,Net_Amt_TTBFX,National_Tax_TTBFX,Local_Tax_TTBFX,Final_Net_Amt_JPY,Gross_Amt_TTBFX,FGN_Tax_TTBFX ) 
				values 
				( '1000000000',getDate(),111,222,333,444,555,666,777)                    
			END
 		 	]]>
			</PARAM>
			<PARAM NAME="resource" VALUE="TAXSYB"/>
			<PARAM NAME="batch.size" VALUE="1"/>
			<PARAM NAME="key.name" VALUE="something"/>
		</WRITER>
		<WRITER NAME="spear1" TYPE="JMS">
			<PARAM NAME="single.reference" VALUE="false"/>
			<PARAM NAME="key.name" VALUE="test"/>
			<PARAM NAME="destination.name" VALUE="LOCALJMS@spear.test.Queue"/>
		</WRITER>
		<WRITER NAME="spearq" TYPE="JMS">
			<PARAM NAME="single.reference" VALUE="false"/>
			<PARAM NAME="key.name" VALUE="trans"/>
			<PARAM NAME="message.1"><![CDATA[
				<root>
					@if{driver$counterparty=="N"}
						<record>${driver$counterparty}</record>
					@else{}
						<record>Inside else ${driver$counterparty}</record>
					@end{}
				</root>
			]]>
			</PARAM>
			<PARAM NAME="key.name" VALUE="trans"/>
			<PARAM NAME="message.2"><![CDATA[
				<root>
					@if{driver$counterparty=="N"}
						<record>${driver$counterparty}</record>
					@else{}
						<record>Inside else ${driver$counterparty}</record>
					@end{}
				</root>
			]]>
			</PARAM>
			<PARAM NAME="msg.property.1" VALUE="abc=test"/>
			<PARAM NAME="msg.property.2" VALUE="abc1=test1"/>
			<PARAM NAME="destination.name" VALUE="LOCALJMS@spear.test.Queue"/>
		</WRITER>
	</DATA-WRITERS>
	<RESOURCES>
		<RESOURCE NAME="TAXSYB" TYPE="DB" LOAD-PRIORITY="2" UNLOAD-PRIORITY="1">
			<PARAM NAME="driver.classname" VALUE="com.sybase.jdbc3.jdbc.SybDriver"/>
			<PARAM NAME="connection.url" VALUE="jdbc:sybase:Tds:${module@taxman.syb.server}/${module@taxman.syb.tempdb}"/>		
			<PARAM NAME="user.name" VALUE="${module@taxman.syb.tempdbuname}"/>
			<PARAM NAME="password" VALUE="${module@taxman.syb.tempdbpwd}"/>
			<PARAM NAME="pool.size" VALUE="10"/>
			<PARAM NAME="pool.on.start" VALUE="false"/>
			<PARAM NAME="max.wait" VALUE="5000"/>
			<PARAM NAME="default.autocommit" VALUE="true"/>
		</RESOURCE>
		<RESOURCE NAME="CMSYB" TYPE="DB" LOAD-PRIORITY="2" UNLOAD-PRIORITY="1">
			<PARAM NAME="driver.classname" VALUE="com.sybase.jdbc3.jdbc.SybDriver"/>
			<PARAM NAME="connection.url" VALUE="jdbc:sybase:Tds:167.168.148.202:2325/cm_db"/>
			<PARAM NAME="user.name" VALUE="app_cm"/>
			<PARAM NAME="password" VALUE="app_cm"/>
			<PARAM NAME="pool.size" VALUE="10"/>
			<PARAM NAME="pool.on.start" VALUE="false"/>
			<PARAM NAME="max.wait" VALUE="5000"/>
			<PARAM NAME="default.autocommit" VALUE="true"/>
		</RESOURCE>
		<RESOURCE NAME="LOCALJMS" TYPE="JMS" LOAD-PRIORITY="2" UNLOAD-PRIORITY="1">
			<PARAM NAME="jms.type" VALUE="queue"/>
			<PARAM NAME="context" VALUE="LOCAL"/>
			<PARAM NAME="connection.factory" VALUE="inspire.queueconnectionfactory"/>
			<PARAM NAME="session.transacted" VALUE="true"/>
			<PARAM NAME="message.ack.type" VALUE="auto"/>
		</RESOURCE>
		<RESOURCE NAME="LOCAL" TYPE="CONTEXT" LOAD-PRIORITY="1" UNLOAD-PRIORITY="2">
			<PARAM NAME="provider.url" VALUE="t3://localhost:7001"/>
			<PARAM NAME="initialcontext.factoy" VALUE="weblogic.jndi.WLInitialContextFactory"/>
		</RESOURCE>
	</RESOURCES>	
       <DATA-PROVIDERS>
                <DATA-PROVIDER NAME="CHECK_FX" TYPE="DB">
			<PARAM NAME="query"><![CDATA[
				select TTBFXRate, FXRate,IssueCurrency from amm_db..FXRates where IssueCurrency = '${driver$tradeccy}'
				and EffDate = (select max(EffDate) from amm_db..FXRates where IssueCurrency = '${driver$tradeccy}' and EffDate <= convert(datetime, '${driver$recorddate}', 103))

			 ]]>
			 </PARAM>
			<PARAM NAME="resource" VALUE="TAXSYB"/>
			<PARAM NAME="fetch.size" VALUE="1"/>
			<PARAM NAME="result.wrap" VALUE="disconnected"/>
			<PARAM NAME="cache.type" VALUE="incremental"/>
                </DATA-PROVIDER>
                <DATA-PROVIDER NAME="CHECK_DTA" TYPE="DB">
			<PARAM NAME="query"><![CDATA[
				select DTARate, IsReliefAvailabeAtSource from amm_db..DTARates where Country = 'JP'
				and EffDate = (select max(EffDate) from amm_db..DTARates where Country = 'JP' and EffDate <= '${driver$recorddate}')
			 ]]>
			 </PARAM>
			<PARAM NAME="resource" VALUE="TAXSYB"/>
			<PARAM NAME="fetch.size" VALUE="1"/>
			<PARAM NAME="result.wrap" VALUE="disconnected"/>
			<!--<PARAM NAME="cache.type" VALUE="incremental"/>-->
                </DATA-PROVIDER>
                <DATA-PROVIDER NAME="CHECK_TAX" TYPE="DB">
			<PARAM NAME="query"><![CDATA[
				select T1.TaxRate, T1.LocalTaxRate from amm_db..TaxRate T1 where T1.Office = '302' and T1.AccountNo = '500623' 
				and T1.Product_Type = 'AAAB'
				and T1.EffDate = (select max(EffDate) from amm_db..TaxRate T2 where T2.Office = '302' and T2.AccountNo = '500623' 
					and T2.Product_Type = 'AAAB' and T2.EffDate <= '${driver$recorddate}')
			 ]]>
			 </PARAM>
			<PARAM NAME="resource" VALUE="TAXSYB"/>
			<PARAM NAME="fetch.size" VALUE="1"/>
			<PARAM NAME="result.wrap" VALUE="disconnected"/>
			<!--<PARAM NAME="cache.type" VALUE="incremental"/>-->
            </DATA-PROVIDER>
           <DATA-PROVIDER NAME="CHECK_SEED" TYPE="DB">
			<PARAM NAME="query"><![CDATA[
				begin
  					set nocount on
					declare @d_out varchar (30)
					declare @fp varchar (2)
					select @fp='TX'
					exec cm_db..GlobalSeedGen @in_str =@fp , @ret_value = @d_out output
					select @d_out as seq_num
				end
			 ]]>
			 </PARAM>
			<PARAM NAME="resource" VALUE="CMSYB"/>
			<PARAM NAME="fetch.size" VALUE="1"/>
			<PARAM NAME="result.wrap" VALUE="disconnected"/>
                </DATA-PROVIDER>
        </DATA-PROVIDERS>
        <DATA-LOOKUP>
                <LOOKUP NAME="FX_RATE"  DATA-PROVIDER="CHECK_FX">
			<FILTER> IssueCurrency =${driver$tradeccy}</FILTER> 
                </LOOKUP>
                <LOOKUP NAME="DTA_RATE"  DATA-PROVIDER="CHECK_DTA">
                </LOOKUP>
                <LOOKUP NAME="TAX_RATE"  DATA-PROVIDER="CHECK_TAX">
                </LOOKUP>
                <LOOKUP NAME="SEED_NUM"  DATA-PROVIDER="CHECK_SEED">
                </LOOKUP>
        </DATA-LOOKUP>
	<EXCEPTION-HANDLER>
		<HANDLER CLASS="com.cs.sg.spear.core.exception.SpearExceptionHandler" NAME="default.exception.handler"/>
		<HANDLE EXCEPTION="com.cs.sg.spear.core.exception.EventNotifierException" HANDLER="default.exception.handler">
			<ERROR CODE="DBINIT_EA_SQL_EXP" VALUE="" TYPE="fatal"/>
			<ERROR CODE="SEMAPHORE_BA_LOCKED" VALUE="" TYPE="fatal"/>
			<ERROR CODE="SEMAPHORE_UNKNOWN" VALUE="" TYPE="fatal"/>
			<ERROR CODE="SEMAPHORE_BA_PROVIDER_NOT_FOUND" VALUE="" TYPE="fatal"/>
		</HANDLE>
		<HANDLE EXCEPTION="com.cs.sg.spear.core.exception.InitializationException" HANDLER="default.exception.handler">
			<ERROR CODE="TOKEN_DBPARAM_EXIST" VALUE="" TYPE="ignore"/>
			<ERROR CODE="APP_INITIALIZATION_EXP" VALUE="" TYPE="fatal"/>
			<ERROR CODE="LOCALJMS_INIT_EXP" VALUE="" TYPE="ignore"/>
		</HANDLE>
		<HANDLE EXCEPTION="com.cs.sg.spear.core.exception.SpearRuntimeException" HANDLER="default.exception.handler">
			<ERROR CODE="FILE_NOT_ARRIVED" VALUE="" TYPE="fatal"/>
		</HANDLE>
		<HANDLE EXCEPTION="java.sql.SQLException" HANDLER="default.exception.handler">
			<ERROR CODE="any" VALUE="Invalid column name" TYPE="fatal"/>
			<ERROR CODE="any" VALUE="invalid identifier" TYPE="ignore"/>
			<ERROR CODE="00001" VALUE="unique constraint" TYPE="fatal"/>
		</HANDLE>
		<HANDLE EXCEPTION="com.cs.sg.spear.core.exception.ValidatorException" HANDLER="default.exception.handler">
			<ERROR CODE="INVALID_FILE" VALUE="" TYPE="fatal"/>
			<ERROR CODE="MISSING_FX_RATE" VALUE="" TYPE="fatal"/>
			<ERROR CODE="MISSING_DTA_RATE" VALUE="" TYPE="fatal"/>
			<ERROR CODE="MISSING_TAX_RATE" VALUE="" TYPE="fatal"/>
		</HANDLE>
		<HANDLE EXCEPTION="com.cs.sg.spear.core.exception.ResourceException" HANDLER="default.exception.handler">
			<ERROR CODE="SQL_EXCEPTION_CON" VALUE="" TYPE="fatal"/>
			<ERROR CODE="DB_DATASOURCE_CREATION" VALUE="" TYPE="fatal"/>
			<ERROR CODE="DB_BATCH_NOT_SUPPORT" VALUE="" TYPE="fatal"/>
		</HANDLE>
		
	</EXCEPTION-HANDLER>
</SPEAR-CONFIG>
